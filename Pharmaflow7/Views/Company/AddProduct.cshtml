@model Pharmaflow7.Models.Product

@{
    ViewData["Title"] = "Add Product";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"] - PharmaFlow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="container py-4">
        <h1 class="mb-4">Add New Product</h1>

        <form asp-action="AddProduct" asp-controller="Company" method="post" id="addProductForm">
            @Html.AntiForgeryToken()
            <div class="mb-3 position-relative">
                <input asp-for="Name" class="form-control" id="productName" placeholder="Product Name" required>
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>
            <div class="mb-3">
                <input asp-for="ProductionDate" type="date" class="form-control" id="productionDate" required>
                <span asp-validation-for="ProductionDate" class="text-danger"></span>
            </div>
            <div class="mb-3">
                <input asp-for="ExpirationDate" type="date" class="form-control" id="expirationDate" required>
                <span asp-validation-for="ExpirationDate" class="text-danger"></span>
            </div>
            <div class="mb-3">
                <textarea asp-for="Description" class="form-control" id="description" rows="3" required placeholder="Description"></textarea>
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>
            <button type="submit" class="btn btn-primary w-100">Add Product & Generate QR Code</button>
        </form>

        <div id="qrCodeContainer" class="mt-4" style="display:none;">
            <h5>Generated QR Code</h5>
            <div id="qrCode"></div>
            <button class="btn btn-primary mt-3" onclick="downloadQR()">Download QR Code</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        document.getElementById('addProductForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const form = e.target;

            const formData = {
                Name: form.productName.value,
                ProductionDate: form.productionDate.value,
                ExpirationDate: form.expirationDate.value,
                Description: form.description.value
            };

            const response = await fetch(form.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (result.success) {
                const qrCodeContainer = document.getElementById('qrCodeContainer');
                qrCodeContainer.style.display = 'block';

                document.getElementById('qrCode').innerHTML = "";
                new QRCode(document.getElementById('qrCode'), {
                    text: result.qrData,
                    width: 150,
                    height: 150,
                    colorDark: '#042557',
                    colorLight: '#ffffff'
                });
            } else {
                alert("Error: " + result.message);
            }
        });

        function downloadQR() {
            const qrImg = document.querySelector('#qrCode img');
            if (!qrImg) return alert("No QR code generated yet!");
            const link = document.createElement('a');
            link.href = qrImg.src;
            link.download = 'PharmaFlow_QR.png';
            link.click();
        }
    </script>
</body>
</html>

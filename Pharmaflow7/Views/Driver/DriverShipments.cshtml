@model IEnumerable<Pharmaflow7.Models.ShipmentViewModel>

@{
    ViewData["Title"] = "شحنات السائق";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
    .no-shipments { font-size: 1.2rem; color: #777; margin-top: 1rem; }
    .loading-overlay { 
        position: fixed; top:0; left:0; width:100%; height:100%; 
        background: rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index:9999;
    }
    .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #007bff; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
    keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .message { position: fixed; top: 10px; right: 10px; padding: 10px 20px; border-radius: 5px; color: white; z-index: 10000; }
    .message.success { background: #28a745; }
    .message.error { background: #dc3545; }
</style>

<div class="container">
    <h1><i class="fas fa-truck"></i> شحنات السائق</h1>

    @if (!Model.Any())
    {
        <p class="no-shipments">لا توجد شحنات متاحة حاليًا.</p>
    }
    else
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>اسم المنتج</th>
                    <th>الوجهة</th>
                    <th>الحالة</th>
                    <th>اسم المتجر</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var shipment in Model)
                {
                    <tr>
                        <td>@shipment.ProductName</td>
                        <td>@shipment.Destination</td>
                        <td id="status_@shipment.Id">@shipment.Status</td>
                        <td>@shipment.StoreAddress</td>
                        <td>
                            <button onclick="updateLocation(@shipment.Id)" class="btn btn-primary">
                                <i class="fas fa-map-marker-alt"></i> تحديث الموقع
                            </button>
                            <button onclick="startTrip(@shipment.Id)" class="btn btn-success" id="startTrip_@shipment.Id" @(shipment.Status=="In Transit" || shipment.Status=="Delivered" ? "disabled" : "")>
                                <i class="fas fa-play"></i> بدء الرحلة
                            </button>
                            <button onclick="endTrip(@shipment.Id)" class="btn btn-danger" id="endTrip_@shipment.Id" @(shipment.Status!="In Transit" ? "disabled" : "")>
                                <i class="fas fa-stop"></i> إنهاء الرحلة
                            </button>
                        </td>
                    </tr>
                    @if (shipment.DestinationLatitude.HasValue && shipment.DestinationLongitude.HasValue)
                    {
                        <tr>
                            <td colspan="5">
                                <div id="map_@shipment.Id" style="height: 300px;"></div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    }
</div>

<div class="loading-overlay" id="loading" style="display:none;">
    <div class="spinner"></div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/trackingHub")
            .build();

        var maps = {}, truckMarkers = {}, routes = {};

        @foreach(var shipment in Model){
            if(shipment.DestinationLatitude.HasValue && shipment.DestinationLongitude.HasValue){
                var lat = shipment.Latitude ?? 30.0444;
                var lng = shipment.Longitude ?? 31.2357;
                <text>
                maps[@shipment.Id] = L.map('map_@shipment.Id').setView([@lat,@lng], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'© OpenStreetMap contributors' }).addTo(maps[@shipment.Id]);
                truckMarkers[@shipment.Id] = L.marker([@lat,@lng]).addTo(maps[@shipment.Id]).bindPopup("شحنة: @shipment.Id<br>الحالة: @shipment.Status");
                routes[@shipment.Id] = L.Routing.control({
                    waypoints: [ L.latLng(@lat,@lng), L.latLng(@shipment.DestinationLatitude.Value,@shipment.DestinationLongitude.Value) ],
                    routeWhileDragging:false,
                    lineOptions:{styles:[{color:'blue', weight:5}]}
                }).addTo(maps[@shipment.Id]);
                </text>
            }
        }

        connection.on("ReceiveLocationUpdate", (shipmentId, latitude, longitude, status) => {
            if(truckMarkers[shipmentId]){
                truckMarkers[shipmentId].setLatLng([latitude, longitude]);
                truckMarkers[shipmentId].setPopupContent(`شحنة: ${shipmentId}<br>الحالة: ${status}`);
                routes[shipmentId].spliceWaypoints(0,1,L.latLng(latitude, longitude));
                document.getElementById(`status_${shipmentId}`).innerText = status;
            }
        });

        connection.on("TripStarted", (shipmentId, status)=>{
            document.getElementById(`startTrip_${shipmentId}`).disabled = true;
            document.getElementById(`endTrip_${shipmentId}`).disabled = false;
            document.getElementById(`status_${shipmentId}`).innerText = status;
            showMessage(`تم بدء الرحلة للشحنة ${shipmentId}!`,'success');
        });

        connection.on("TripEnded", (shipmentId, status)=>{
            document.getElementById(`endTrip_${shipmentId}`).disabled = true;
            document.getElementById(`status_${shipmentId}`).innerText = status;
            showMessage(`تم إنهاء الرحلة للشحنة ${shipmentId}!`,'success');
        });

        connection.start().catch(err=>console.error(err));

        function showMessage(msg,type){
            const div = document.createElement('div');
            div.className=`message ${type}`;
            div.innerHTML=`<i class="fas ${type==='success'?'fa-check-circle':'fa-exclamation-circle'}"></i> ${msg}`;
            document.body.appendChild(div);
            setTimeout(()=>div.remove(),5000);
        }

        function updateLocation(shipmentId){
            if(navigator.geolocation){
                navigator.geolocation.getCurrentPosition(pos=>{
                    connection.invoke("UpdateLocation", shipmentId, pos.coords.latitude, pos.coords.longitude)
                    .catch(err=>console.error(err));
                }, err=>console.error(err));
            }
        }

        function startTrip(shipmentId){ connection.invoke("StartTrip", shipmentId).catch(err=>console.error(err)); }
        function endTrip(shipmentId){ connection.invoke("EndTrip", shipmentId).catch(err=>console.error(err)); }
    </script>
}

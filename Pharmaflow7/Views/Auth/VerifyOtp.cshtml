@model OtpVerificationViewModel

@{
    ViewData["Title"] = "Verify Email";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"] - Pharmaflow7</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="~/css/Signup.css" asp-append-version="true" />
</head>
<body>
<div class="d-flex justify-content-center align-items-center">
    <div class="background-animation">
        <div class="bubble" style="left: 10%; animation-duration: 8s;"></div>
        <div class="bubble" style="left: 30%; animation-duration: 12s;"></div>
        <div class="bubble" style="left: 50%; animation-duration: 9s;"></div>
        <div class="bubble" style="left: 70%; animation-duration: 14s;"></div>
        <div class="bubble" style="left: 90%; animation-duration: 10s;"></div>
    </div>

    <div class="signup-container text-center">
        <div class="mb-4">
            <i class="fas fa-shield-alt fa-4x text-primary"></i>
        </div>
        
        <h2 class="fw-bold sign mb-3">Verify Your Email</h2>
        
        <p class="mb-4 text-white">
            We've sent a 6-digit verification code to <br>
            <strong>@Model.Email</strong>
        </p>

        <!-- Alert Messages -->
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }
        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <form asp-action="VerifyOtp" method="post" id="otpForm">
            <input type="hidden" asp-for="Email" />
            
            <div class="mb-4">
                <label class="form-label text-white">Enter 6-Digit Code</label>
                <div class="otp-input-container d-flex justify-content-center gap-2">
                    <input type="text" class="otp-digit form-control text-center" maxlength="1" data-index="0">
                    <input type="text" class="otp-digit form-control text-center" maxlength="1" data-index="1">
                    <input type="text" class="otp-digit form-control text-center" maxlength="1" data-index="2">
                    <input type="text" class="otp-digit form-control text-center" maxlength="1" data-index="3">
                    <input type="text" class="otp-digit form-control text-center" maxlength="1" data-index="4">
                    <input type="text" class="otp-digit form-control text-center" maxlength="1" data-index="5">
                </div>
                <input type="hidden" asp-for="OtpCode" id="hiddenOtpCode" />
                <span asp-validation-for="OtpCode" class="text-danger"></span>
            </div>

            <button type="submit" class="btn btn-primary w-100 mb-3" id="verifyBtn">
                <i class="fas fa-check me-2"></i>Verify Code
            </button>
        </form>

        <div class="resend-section">
            <p class="text-white mb-2">Didn't receive the code?</p>
            <button type="button" class="btn btn-outline-light" id="resendBtn" onclick="resendOtp()">
                <i class="fas fa-paper-plane me-2"></i>Resend Code
            </button>
            <div id="countdown" class="mt-2 text-warning" style="display: none;">
                Please wait <span id="countdownTimer">120</span> seconds before requesting another code
            </div>
        </div>

        <div class="mt-4">
            <a asp-action="Login" class="btn btn-link text-white">
                <i class="fas fa-arrow-left me-2"></i>Back to Login
            </a>
        </div>
    </div>
</div>

<style>
    .otp-digit {
        width: 50px;
        height: 50px;
        font-size: 24px;
        font-weight: bold;
        border: 2px solid #007bff;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.9);
        color: #333;
    }
    
    .otp-digit:focus {
        border-color: #0056b3;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        outline: none;
    }
    
    .otp-input-container {
        max-width: 350px;
        margin: 0 auto;
    }
    
    .resend-section {
        margin-top: 30px;
    }
    
    .btn-outline-light:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .fa-shield-alt {
        filter: drop-shadow(0 4px 8px rgba(0,123,255,0.3));
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const otpInputs = document.querySelectorAll('.otp-digit');
        const hiddenOtpInput = document.getElementById('hiddenOtpCode');
        
        // Handle OTP input behavior
        otpInputs.forEach((input, index) => {
            input.addEventListener('input', function(e) {
                const value = e.target.value;
                
                if (value.length === 1 && /^\d$/.test(value)) {
                    // Move to next input
                    if (index < otpInputs.length - 1) {
                        otpInputs[index + 1].focus();
                    }
                } else if (value.length > 1) {
                    // Handle paste
                    const pastedValue = value.slice(0, 6);
                    for (let i = 0; i < pastedValue.length && i + index < otpInputs.length; i++) {
                        otpInputs[index + i].value = pastedValue[i];
                    }
                    if (index + pastedValue.length < otpInputs.length) {
                        otpInputs[index + pastedValue.length].focus();
                    }
                }
                
                updateHiddenInput();
            });
            
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
                    otpInputs[index - 1].focus();
                }
            });
            
            input.addEventListener('paste', function(e) {
                e.preventDefault();
                const pastedData = e.clipboardData.getData('text').replace(/\D/g, '').slice(0, 6);
                
                for (let i = 0; i < pastedData.length && i + index < otpInputs.length; i++) {
                    otpInputs[index + i].value = pastedData[i];
                }
                
                updateHiddenInput();
                
                if (index + pastedData.length < otpInputs.length) {
                    otpInputs[index + pastedData.length].focus();
                }
            });
        });
        
        function updateHiddenInput() {
            const otpValue = Array.from(otpInputs).map(input => input.value).join('');
            hiddenOtpInput.value = otpValue;
        }
        
        // Focus first input
        otpInputs[0].focus();
    });
    
    function resendOtp() {
        const resendBtn = document.getElementById('resendBtn');
        const countdown = document.getElementById('countdown');
        const countdownTimer = document.getElementById('countdownTimer');
        
        resendBtn.disabled = true;
        countdown.style.display = 'block';
        
        fetch('@Url.Action("ResendOtp", "Auth")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: 'email=@Model.Email'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                showAlert('success', data.message);
                
                // Start countdown
                let timeLeft = 120;
                const countdownInterval = setInterval(() => {
                    timeLeft--;
                    countdownTimer.textContent = timeLeft;
                    
                    if (timeLeft <= 0) {
                        clearInterval(countdownInterval);
                        resendBtn.disabled = false;
                        countdown.style.display = 'none';
                    }
                }, 1000);
            } else {
                showAlert('danger', data.message);
                resendBtn.disabled = false;
                countdown.style.display = 'none';
            }
        })
        .catch(error => {
            showAlert('danger', 'Failed to resend code. Please try again.');
            resendBtn.disabled = false;
            countdown.style.display = 'none';
        });
    }
    
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.querySelector('.signup-container');
        container.insertBefore(alertDiv, container.querySelector('form'));
        
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }
</script>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
}
</body>
</html>